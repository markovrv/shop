# Bookkeeping Server

Серверная часть приложения для учета финансовых проводок. Разработана на Node.js с использованием Express и MySQL для хранения данных.

## Функциональность

- REST API для управления счетами, проводками и остатками
- Расчет остатков по счетам с учетом типа счета (активы, пассивы, капитал, доходы, расходы)
- Аутентификация и авторизация пользователей
- Валидация входных данных
- Логирование операций
- Административные функции (пересчет остатков, проверка состояния системы)

## Технологии

- Node.js 18+
- Express — веб-фреймворк
- MySQL — реляционная база данных
- mysql2 — драйвер для подключения к MySQL
- zod — валидация данных
- jsonwebtoken — аутентификация и авторизация
- bcryptjs — хеширование паролей
- cors — настройки CORS
- dotenv — переменные окружения

## Установка

```bash
npm install
```

## Настройка

Создайте файл `.env` в корне проекта на основе `.env.example`:

```env
NODE_ENV=development
PORT=3000
DB_HOST=localhost
DB_USER=your_username
DB_PASSWORD=your_password
DB_NAME=bookkeeping
JWT_SECRET=your_jwt_secret
```

## Запуск

```bash
# Для разработки
npm run dev

# Для продакшена
npm start
```

## Структура проекта

```
server/
├── src/
│   ├── db/                 # Подключение и инициализация базы данных
│   │   ├── connection.js   # Подключение к MySQL
│   │   └── init.js         # Инициализация таблиц
│   ├── routes/             # Маршруты API
│   │   ├── accounts.js     # Управление счетами
│   │   ├── entries.js      # Управление проводками
│   │   ├── balances.js     # Расчет остатков
│   │   ├── admin.js        # Административные функции
│   │   └── auth.js         # Аутентификация
│   ├── middleware/         # Middleware
│   │   ├── auth.js         # Аутентификация
│   │   ├── errorHandler.js # Обработка ошибок
│   │   └── validator.js    # Валидация данных
│   ├── utils/              # Утилиты
│   │   └── logger.js       # Логирование
│   └── index.js            # Основной файл сервера
├── .env                    # Переменные окружения
├── .env.example           # Пример файла конфигурации
├── .gitignore
├── package.json
└── README.md
```

## API Endpoints

### Аутентификация
- `POST /api/auth/login` - вход пользователя
- `POST /api/auth/register` - регистрация пользователя
- `POST /api/auth/logout` - выход пользователя

### Счета
- `GET /api/accounts` - получить все счета
- `POST /api/accounts` - создать счет
- `PUT /api/accounts/:id` - обновить счет
- `DELETE /api/accounts/:id` - удалить счет

### Проводки
- `GET /api/entries` - получить проводки с фильтрацией
- `POST /api/entries` - создать проводку
- `PUT /api/entries/:id` - обновить проводку
- `DELETE /api/entries/:id` - удалить проводку

### Остатки
- `GET /api/balances` - получить остатки по счетам

### Администрирование
- `POST /api/admin/recalculate` - перепровести все проводки
- `GET /api/admin/health` - проверка состояния сервера

## Зависимости

См. `package.json` для полного списка зависимостей.

## Безопасность

- Валидация всех входных данных (zod)
- Защита от SQL injection (prepared statements)
- CORS для разработки и production
- Обработка и логирование ошибок
- JWT токены для аутентификации
- Хеширование паролей с помощью bcrypt

## Логика расчета баланса

Для каждого счета баланс считается как:

```
Активы и расходы (asset, expense):
  Баланс = Начальный баланс + Дебет - Кредит

Пассивы, капитал и доходы (liability, equity, income):
  Баланс = Начальный баланс + Кредит - Дебет
```

## Production развертывание

Для production развертывания:

1. Установите `NODE_ENV=production` в переменных окружения
2. Настройте подключение к production базе данных
3. Используйте reverse proxy (например, nginx) для обслуживания статики и SSL